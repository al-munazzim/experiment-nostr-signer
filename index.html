<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NIP-07 Encrypt / Decrypt POC</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, system-ui, sans-serif; max-width: 640px; margin: 2rem auto; padding: 0 1rem; color: #222; background: #fafafa; }
h1 { font-size: 1.4rem; margin-bottom: .5rem; }
p.sub { color: #666; margin-bottom: 1.5rem; font-size: .9rem; }
label { display: block; font-weight: 600; margin: 1rem 0 .3rem; font-size: .85rem; }
input, textarea { width: 100%; padding: .5rem; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: .85rem; }
textarea { height: 100px; resize: vertical; }
.buttons { display: flex; gap: .5rem; margin: 1rem 0; }
button { padding: .5rem 1.2rem; border: none; border-radius: 4px; cursor: pointer; font-size: .9rem; font-weight: 600; }
#encryptBtn { background: #4a90d9; color: #fff; }
#decryptBtn { background: #5cb85c; color: #fff; }
button:hover { opacity: .85; }
#status { margin-top: 1rem; padding: .6rem; border-radius: 4px; font-size: .85rem; display: none; }
#status.error { display: block; background: #fdd; color: #a00; border: 1px solid #e99; }
#status.ok { display: block; background: #dfd; color: #060; border: 1px solid #9c9; }
#status.warn { display: block; background: #ffe8c0; color: #855; border: 1px solid #dca; }
#nostr-warning { background: #fdd; color: #a00; border: 1px solid #e99; padding: .8rem; border-radius: 4px; margin-bottom: 1rem; }
</style>
</head>
<body>
<h1>üîê NIP-07 Encrypt / Decrypt</h1>
<p class="sub">Encrypt &amp; decrypt via your browser signer extension.</p>

<label for="nip-select">Encryption Protocol</label>
<select id="nip-select" style="width:100%;padding:.5rem;border:1px solid #ccc;border-radius:4px;font-size:.85rem;margin-bottom:.5rem;">
  <option value="nip04">NIP-04 (AES-256-CBC, legacy)</option>
  <option value="nip44">NIP-44 (XChaCha20, recommended)</option>
</select>
<div id="nostr-warning" style="display:none">
  <strong>No NIP-07 signer detected.</strong><br>
  Install a browser extension like <a href="https://github.com/nicehash/nos2x">nos2x</a>, <a href="https://getalby.com">Alby</a>, or another NIP-07 compatible signer.
</div>

<label for="pubkey">Recipient Public Key (hex)</label>
<input id="pubkey" type="text" placeholder="64-char hex pubkey of the other party">

<label for="plaintext">Plaintext</label>
<textarea id="plaintext" placeholder="Message to encrypt..."></textarea>

<div class="buttons">
  <button id="encryptBtn">Encrypt ‚Üì</button>
  <button id="decryptBtn">Decrypt ‚Üë</button>
</div>

<label for="ciphertext">Ciphertext</label>
<textarea id="ciphertext" placeholder="Encrypted payload appears here..."></textarea>

<div id="status"></div>

<script>
const $ = id => document.getElementById(id);

function status(msg, cls) {
  const el = $('status');
  el.textContent = msg;
  el.className = cls;
}

function getProtocol() {
  const nip = $('nip-select').value;
  if (nip === 'nip44') {
    if (!window.nostr || !window.nostr.nip44) return null;
    return window.nostr.nip44;
  }
  if (!window.nostr || !window.nostr.nip04) return null;
  return window.nostr.nip04;
}

function checkNostr() {
  const proto = getProtocol();
  if (!proto) {
    const nip = $('nip-select').value.toUpperCase();
    $('nostr-warning').style.display = 'block';
    $('nostr-warning').innerHTML = '<strong>No ' + nip + ' signer detected.</strong><br>Install a NIP-07 extension like <a href="https://github.com/nicehash/nos2x">nos2x</a> or <a href="https://getalby.com">Alby</a>. Make sure it supports ' + nip + '.';
    $('encryptBtn').disabled = true;
    $('decryptBtn').disabled = true;
    return false;
  }
  $('nostr-warning').style.display = 'none';
  $('encryptBtn').disabled = false;
  $('decryptBtn').disabled = false;
  return true;
}

setTimeout(checkNostr, 500);
$('nip-select').addEventListener('change', checkNostr);

$('encryptBtn').addEventListener('click', async () => {
  if (!checkNostr()) return;
  const proto = getProtocol();
  const pubkey = $('pubkey').value.trim();
  const plaintext = $('plaintext').value;
  if (!pubkey || !plaintext) { status('Provide pubkey and plaintext.', 'error'); return; }
  try {
    status('Encrypting via ' + $('nip-select').value.toUpperCase() + '‚Ä¶', 'ok');
    const ct = await proto.encrypt(pubkey, plaintext);
    $('ciphertext').value = ct;
    status('Encrypted OK (' + $('nip-select').value.toUpperCase() + ').', 'ok');
  } catch (e) {
    status('Encrypt failed: ' + e.message, 'error');
  }
});

$('decryptBtn').addEventListener('click', async () => {
  if (!checkNostr()) return;
  const proto = getProtocol();
  const pubkey = $('pubkey').value.trim();
  const ciphertext = $('ciphertext').value.trim();
  if (!pubkey || !ciphertext) { status('Provide pubkey and ciphertext.', 'error'); return; }
  try {
    status('Decrypting via ' + $('nip-select').value.toUpperCase() + '‚Ä¶', 'ok');
    const pt = await proto.decrypt(pubkey, ciphertext);
    $('plaintext').value = pt;
    status('Decrypted OK (' + $('nip-select').value.toUpperCase() + ').', 'ok');
  } catch (e) {
    status('Decrypt failed: ' + e.message, 'error');
  }
});
</script>
</body>
</html>
